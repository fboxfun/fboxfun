---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import BoxSpinner from '../../components/BoxSpinner.astro';
import { mysteryBoxes } from '../../data/boxes';

export function getStaticPaths() {
  return mysteryBoxes.map((box) => ({
    params: { slug: box.slug },
    props: { box },
  }));
}

const { box } = Astro.props;
const spinnerId = `spinner-${box.id}`;
---

<Layout
  title={`${box.name} - FortuneBox | Mystery Box`}
  description={`Open the ${box.name} mystery box for ${box.price}. Compete and win amazing prizes!`}
  image={box.image}
>
  <Header />
  
  <main class="min-h-screen bg-[#121212] pt-20 md:pt-24 pb-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      
      <!-- Spinner Section -->
      <div class="mb-8">
        <!-- New Architecture Spinner -->
        <BoxSpinner box={box} spinnerId={spinnerId} />

        <!-- Action Buttons -->
        <div class="flex justify-center items-center gap-4 mb-12 mt-12">
          <button
            id="demo-spin-btn"
            type="button"
            class="px-8 py-3 bg-transparent border-2 border-white text-white font-bold rounded-full hover:bg-white/10 transition-all"
          >
            Spin for free!
          </button>
        </div>
      </div>

      <!-- Possible Drops Section -->
      <div class="mt-12">
        <h2 class="text-2xl md:text-3xl font-bold mb-8 text-white">Possible Drops</h2>
        <div id="possible-drops-grid" class="possible-drops-container">
          <!-- Items will be populated by JavaScript -->
        </div>
      </div>

    </div>
  </main>

  <Footer />
</Layout>


<style is:global>
  /* Possible Drops Container */
  .possible-drops-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
  }

  @media (min-width: 640px) {
    .possible-drops-container {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (min-width: 768px) {
    .possible-drops-container {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .possible-drops-container {
      grid-template-columns: repeat(5, 1fr);
    }
  }

  @media (min-width: 1280px) {
    .possible-drops-container {
      grid-template-columns: repeat(8, 1fr);
    }
  }

  /* Possible Drops Item Styles */
  .drop-item {
    background: #1a1a1a;
    border: 1px solid #2a2a2a;
    border-radius: 8px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    transition: all 0.2s ease;
    cursor: pointer;
    overflow: hidden;
  }

  .drop-item::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 8px;
    padding: 1px;
    background: linear-gradient(180deg, transparent 0%, transparent 100%);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .drop-item:hover {
    transform: translateY(-2px);
    border-color: #3a3a3a;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
  }

  .drop-item:hover::before {
    opacity: 1;
  }

  .drop-item-rarity {
    position: absolute;
    top: 6px;
    left: 6px;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    z-index: 2;
  }

  .drop-item-chance {
    position: absolute;
    top: 6px;
    right: 6px;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    z-index: 2;
  }

  .drop-item-image-wrapper {
    width: 100%;
    height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 28px 0 8px;
    position: relative;
  }

  .drop-item img {
    max-width: 90%;
    max-height: 90%;
    object-fit: contain;
    filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.3));
  }

  .drop-item-name {
    font-size: 11px;
    color: #999;
    text-align: center;
    margin-bottom: 6px;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    width: 100%;
    line-height: 1.3;
    min-height: 28px;
  }

  .drop-item-value {
    font-size: 14px;
    font-weight: bold;
    color: #FF3851;
    display: flex;
    align-items: center;
    gap: 2px;
  }

  .drop-item-value::before {
    content: '$';
    font-size: 12px;
    opacity: 0.9;
  }

  /* Rarity Colors - CS:GO Inspired */
  .rarity-legendary {
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
    color: #000;
  }

  .rarity-epic {
    background: linear-gradient(135deg, #9B59B6 0%, #E91E63 100%);
    color: #fff;
  }

  .rarity-rare {
    background: linear-gradient(135deg, #8E44AD 0%, #3498DB 100%);
    color: #fff;
  }

  .rarity-uncommon {
    background: linear-gradient(135deg, #5DADE2 0%, #1ABC9C 100%);
    color: #fff;
  }

  .rarity-common {
    background: linear-gradient(135deg, #7F8C8D 0%, #95A5A6 100%);
    color: #fff;
  }

  /* Rarity color backgrounds for cards */
  .drop-item.has-legendary {
    background: linear-gradient(180deg, rgba(255, 215, 0, 0.05) 0%, #1a1a1a 50%);
  }

  .drop-item.has-epic {
    background: linear-gradient(180deg, rgba(155, 89, 182, 0.05) 0%, #1a1a1a 50%);
  }

  .drop-item.has-rare {
    background: linear-gradient(180deg, rgba(142, 68, 173, 0.05) 0%, #1a1a1a 50%);
  }

  .drop-item.has-uncommon {
    background: linear-gradient(180deg, rgba(52, 152, 219, 0.05) 0%, #1a1a1a 50%);
  }

  .drop-item.has-common {
    background: linear-gradient(180deg, rgba(127, 140, 141, 0.05) 0%, #1a1a1a 50%);
  }

  @media (max-width: 640px) {
    .drop-item-image-wrapper {
      height: 80px;
      margin: 24px 0 6px;
    }
    
    .drop-item-name {
      font-size: 10px;
      min-height: 26px;
    }
    
    .drop-item-value {
      font-size: 12px;
    }
  }
</style>

<script define:vars={{ box, spinnerId }}>
  // Inject prize data for BoxSpinner
  console.log('üì¶ Page script: Injecting prizes for box:', box.id);
  const prizes = box.prizes || [];
  console.log('üì¶ Page script: Prizes count:', prizes.length);
  window[`${box.id}_prizes`] = prizes;
  console.log('üì¶ Page script: Stored at window.' + `${box.id}_prizes`);
  
  // Populate Possible Drops Grid
  function populatePossibleDrops() {
    const grid = document.getElementById('possible-drops-grid');
    if (!grid || !prizes || prizes.length === 0) return;

    prizes.forEach(prize => {
      const dropItem = document.createElement('div');
      dropItem.className = `drop-item has-${prize.rarity.toLowerCase()}`;
      
      const rarityClass = `rarity-${prize.rarity.toLowerCase()}`;
      const chancePercent = (prize.dropChance * 100).toFixed(4);
      
      dropItem.innerHTML = `
        <div class="drop-item-chance">${chancePercent}%</div>
        <div class="drop-item-image-wrapper">
          <img src="${prize.image}" alt="${prize.name}" draggable="false">
        </div>
        <div class="drop-item-name">${prize.name}</div>
        <div class="drop-item-value">${prize.value.toFixed(2)}</div>
      `;
      
      grid.appendChild(dropItem);
    });
  }

  // Event Listeners
  document.addEventListener('DOMContentLoaded', () => {
    console.log('üîò Page script: DOMContentLoaded fired');
    // Populate possible drops on load
    populatePossibleDrops();

    // Wait for spinner controller to be ready
    function waitForSpinner(maxAttempts = 50) {
      let attempts = 0;
      
      return new Promise((resolve, reject) => {
        const checkInterval = setInterval(() => {
          attempts++;
          console.log(`üîç Attempt ${attempts}: Looking for spinner_${spinnerId}`);
          
          const spinner = window[`spinner_${spinnerId}`];
          
          if (spinner) {
            console.log('‚úÖ Page script: Spinner controller found:', spinner);
            clearInterval(checkInterval);
            resolve(spinner);
          } else if (attempts >= maxAttempts) {
            console.error('‚ùå Page script: Spinner controller not found after', attempts, 'attempts');
            console.log('Available window keys:', Object.keys(window).filter(k => k.includes('spinner')));
            clearInterval(checkInterval);
            reject(new Error('Spinner controller not found'));
          }
        }, 100); // Check every 100ms
      });
    }

    // Setup event listeners once spinner is ready
    waitForSpinner().then(spinner => {
      const demoBtn = document.getElementById('demo-spin-btn');
      
      if (demoBtn) {
        console.log('‚úÖ Page script: Demo button found');
        demoBtn.addEventListener('click', async () => {
          console.log('üîò Demo spin button clicked');
          
          if (spinner.isActive()) {
            console.warn('‚ö†Ô∏è Already spinning');
            return;
          }
          
          // Disable button during spin
          demoBtn.disabled = true;
          demoBtn.classList.add('opacity-50', 'cursor-not-allowed');
          
          try {
            const winner = await spinner.spin(true, false);
            console.log('üéÆ Demo spin complete, winner:', winner);
          } finally {
            // Re-enable button
            demoBtn.disabled = false;
            demoBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          }
        });
      } else {
        console.error('‚ùå Page script: Demo button not found');
      }
    }).catch(error => {
      console.error('‚ùå Failed to initialize spinner:', error);
    });
  });
</script>

